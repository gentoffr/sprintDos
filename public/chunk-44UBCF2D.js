import{a as F,c as L,e as Y,j as J,l as K,n as Q,o as U}from"./chunk-LYNVSPLS.js";import{D as h,E as r,F as i,H as v,I as g,J as C,K as O,L as P,M as E,N as M,O as o,P as b,Q as T,R as V,S as D,T as I,W as j,X as R,c as w,ca as H,da as A,ea as B,fa as z,i as S,ja as N,l as k,m,n as d,s as c,u as _,v as y,z as x}from"./chunk-RZ5QBUIN.js";import"./chunk-LJ5XHLMQ.js";import{h as u}from"./chunk-FK42CRUA.js";var f=class s{constructor(e){this.supabaseService=e;this.loadMessages(),this.subscribeToMessages()}messagesSubject=new w([]);messages$=this.messagesSubject.asObservable();channel;loadMessages(){return u(this,null,function*(){try{let{data:e,error:n}=yield this.supabaseService.supabase.from("chat_messages").select("*").order("created_at",{ascending:!0});if(n)throw n;return this.messagesSubject.next(e||[]),e}catch(e){throw console.error("Error cargando mensajes:",e),e}})}sendMessage(e,n){return u(this,null,function*(){try{let{data:t,error:a}=yield this.supabaseService.supabase.from("chat_messages").insert([{content:e.trim(),user_email:n}]).select();if(a)throw a;return t}catch(t){throw console.error("Error enviando mensaje:",t),t}})}subscribeToMessages(){this.channel=this.supabaseService.supabase.channel("chat_messages_realtime",{config:{broadcast:{self:!1}}}).on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},e=>{console.log("Nuevo mensaje detectado:",e);let n=e.new,t=this.messagesSubject.value;this.messagesSubject.next([...t,n])}).on("postgres_changes",{event:"DELETE",schema:"public",table:"chat_messages"},e=>{console.log("Mensaje eliminado:",e);let n=e.old,a=this.messagesSubject.value.filter(l=>l.id!==n.id);this.messagesSubject.next(a)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"chat_messages"},e=>{console.log("Mensaje actualizado:",e);let n=e.new,a=this.messagesSubject.value.map(l=>l.id===n.id?n:l);this.messagesSubject.next(a)}).subscribe(e=>{console.log("Estado del canal de tiempo real:",e),e==="SUBSCRIBED"?console.log("\u2705 Chat en tiempo real conectado exitosamente"):e==="CHANNEL_ERROR"&&(console.error("\u274C Error en la conexi\xF3n de tiempo real"),setTimeout(()=>this.reconnectRealtime(),5e3))})}reconnectRealtime(){console.log("\u{1F504} Intentando reconectar tiempo real..."),this.unsubscribe(),this.subscribeToMessages()}unsubscribe(){this.channel&&(this.supabaseService.supabase.removeChannel(this.channel),this.channel=null)}getConnectionStatus(){return this.channel?.state||"disconnected"}forceReconnect(){this.reconnectRealtime()}static \u0275fac=function(n){return new(n||s)(k(Q))};static \u0275prov=S({token:s,factory:s.\u0275fac,providedIn:"root"})};var G=["chatMessages"];function X(s,e){if(s&1&&(r(0,"div",25)(1,"div",26)(2,"span",27),o(3),i(),r(4,"span",28),o(5),j(6,"date"),i()(),r(7,"div",29),o(8),i()()),s&2){let n=e.$implicit,t=C();M("own-message",n.user_email===(t.user==null?null:t.user.email)),c(3),b(n.user_email),c(2),b(R(6,5,n.created_at,"short")),c(3),b(n.content)}}function Z(s,e){s&1&&(r(0,"div",30),o(1," No hay mensajes a\xFAn. \xA1S\xE9 el primero en escribir algo! \u{1F3AE} "),i())}function ee(s,e){if(s&1){let n=v();r(0,"div",31)(1,"button",32),g("click",function(){m(n);let a=C();return d(a.toggleChat())}),o(2," \u{1F4AC} Abrir Chat "),i()()}}var W=class s{constructor(e,n){this.authService=e;this.chatService=n}chatMessagesContainer;user=null;messages=[];newMessage="";subscriptions=[];isChatVisible=!1;connectionStatus="connecting";shouldScrollToBottom=!1;ngOnInit(){let e=this.authService.user$.subscribe(t=>{this.user=t});this.subscriptions.push(e);let n=this.chatService.messages$.subscribe(t=>{let a=this.messages.length;this.messages=t,t.length>a&&(this.shouldScrollToBottom=!0)});this.subscriptions.push(n),setInterval(()=>{this.connectionStatus=this.chatService.getConnectionStatus()},2e3)}ngAfterViewChecked(){this.shouldScrollToBottom&&(this.scrollToBottom(),this.shouldScrollToBottom=!1)}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe()),this.chatService.unsubscribe()}logout(){this.authService.logout().then(()=>{this.authService.redirectToLogin()})}toggleChat(){this.isChatVisible=!this.isChatVisible,this.isChatVisible&&setTimeout(()=>this.scrollToBottom(),100)}scrollToBottom(){try{if(this.chatMessagesContainer){let e=this.chatMessagesContainer.nativeElement;e.scrollTop=e.scrollHeight}}catch(e){console.log("Error al hacer scroll:",e)}}sendMessage(){return u(this,null,function*(){if(this.newMessage.trim()){if(!this.user?.email){alert("Debes iniciar sesi\xF3n para enviar mensajes en el chat");return}try{yield this.chatService.sendMessage(this.newMessage,this.user.email),this.newMessage="",this.shouldScrollToBottom=!0}catch(e){console.error("Error enviando mensaje:",e),alert("Error enviando mensaje. Intenta de nuevo.")}}})}onKeyPress(e){e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())}forceReconnect(){this.chatService.forceReconnect(),this.connectionStatus="reconnecting"}getConnectionIndicator(){switch(this.connectionStatus){case"SUBSCRIBED":return"\u{1F7E2}";case"CHANNEL_ERROR":return"\u{1F534}";case"connecting":return"\u{1F7E1}";case"reconnecting":return"\u{1F7E1}";default:return"\u26AB"}}trackByMessageId(e,n){return n.id||e}static \u0275fac=function(n){return new(n||s)(_(U),_(f))};static \u0275cmp=y({type:s,selectors:[["app-home"]],viewQuery:function(n,t){if(n&1&&O(G,5),n&2){let a;P(a=E())&&(t.chatMessagesContainer=a.first)}},decls:57,vars:10,consts:[["chatMessages",""],[1,"navbar"],[1,"logo"],[1,"nav-links"],["routerLink","/"],["routerLink","/about"],["routerLink","/contact"],["type","button",1,"chat-toggle-btn",3,"click"],["type","button",3,"click"],[1,"container"],[1,"game-grid"],[1,"game-card"],[1,"chat-panel"],[1,"chat-header"],[1,"connection-status"],[3,"title"],["title","Reconectar",1,"reconnect-btn",3,"click"],[1,"close-btn",3,"click"],[1,"chat-messages"],["class","message",3,"own-message",4,"ngFor","ngForOf","ngForTrackBy"],["class","no-messages",4,"ngIf"],[1,"chat-input"],["type","text","placeholder","Escribe tu mensaje...","maxlength","500",1,"message-input",3,"ngModelChange","keypress","ngModel"],[1,"send-btn",3,"click"],["class","chat-closed-indicator",4,"ngIf"],[1,"message"],[1,"message-header"],[1,"user"],[1,"time"],[1,"message-content"],[1,"no-messages"],[1,"chat-closed-indicator"],[1,"chat-indicator-btn",3,"click"]],template:function(n,t){if(n&1){let a=v();r(0,"nav",1)(1,"div",2),o(2,"Dragon bolseta"),i(),r(3,"ul",3)(4,"li"),o(5),i(),r(6,"li")(7,"a",4),o(8,"Home"),i()(),r(9,"li")(10,"a",5),o(11,"Acerca"),i()(),r(12,"li")(13,"a",6),o(14,"Contacto"),i()(),r(15,"li")(16,"button",7),g("click",function(){return m(a),d(t.toggleChat())}),o(17,"\u{1F4AC} CHAT"),i()(),r(18,"li")(19,"button",8),g("click",function(){return m(a),d(t.logout())}),o(20,"Cerrar Sesi\xF3n "),i()()()(),r(21,"main",9)(22,"h1"),o(23,"Bienvenido"),i(),r(24,"div",10)(25,"div",11)(26,"h2"),o(27,"Juego 1"),i()(),r(28,"div",11)(29,"h2"),o(30,"Juego 2"),i()(),r(31,"div",11)(32,"h2"),o(33,"Juego 3"),i()(),r(34,"div",11)(35,"h2"),o(36,"Juego 4"),i()()(),r(37,"div",12)(38,"div",13)(39,"h3"),o(40,"\u{1F4AC} Chat General"),i(),r(41,"div",14)(42,"span",15),o(43),i(),r(44,"button",16),g("click",function(){return m(a),d(t.forceReconnect())}),o(45,"\u{1F504}"),i()(),r(46,"button",17),g("click",function(){return m(a),d(t.toggleChat())}),o(47,"\u2716"),i()(),r(48,"div",18,0),x(50,X,9,8,"div",19)(51,Z,2,0,"div",20),i(),r(52,"div",21)(53,"input",22),I("ngModelChange",function(p){return m(a),D(t.newMessage,p)||(t.newMessage=p),d(p)}),g("keypress",function(p){return m(a),d(t.onKeyPress(p))}),i(),r(54,"button",23),g("click",function(){return m(a),d(t.sendMessage())}),o(55," ENVIAR "),i()()(),x(56,ee,3,0,"div",24),i()}n&2&&(c(5),T("Hola, ",t.user==null?null:t.user.email),c(32),M("visible",t.isChatVisible),c(5),h("title",t.connectionStatus),c(),b(t.getConnectionIndicator()),c(7),h("ngForOf",t.messages)("ngForTrackBy",t.trackByMessageId),c(),h("ngIf",t.messages.length===0),c(2),V("ngModel",t.newMessage),c(3),h("ngIf",!t.isChatVisible))},dependencies:[N,K,F,L,J,Y,z,H,A,B],styles:[".navbar[_ngcontent-%COMP%]{width:100vw;margin:0;box-sizing:border-box;display:flex;justify-content:space-between;align-items:center;background-color:#1e293b;color:#fff;padding:1rem 2rem;box-shadow:0 2px 4px #0003}.logo[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700}.nav-links[_ngcontent-%COMP%]{list-style:none;justify-content:center;align-items:center;display:flex;gap:1.5rem;margin:0;padding:0}.nav-links[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#fff;text-decoration:none;font-weight:500;transition:opacity .2s}.nav-links[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:hover{opacity:.7}.container[_ngcontent-%COMP%]{max-width:1000px;margin:2rem auto;padding:0 1rem;text-align:center}.game-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;margin-top:2rem}.game-card[_ngcontent-%COMP%]{background:#f8fafc;border:2px solid #e2e8f0;border-radius:1rem;padding:2rem 1rem;cursor:pointer;box-shadow:0 2px 6px #0000001a;transition:transform .2s,box-shadow .2s}.game-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px);box-shadow:0 4px 12px #00000026}.game-card[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:1.3rem;color:#1e293b}button[type=button][_ngcontent-%COMP%]:hover{background:linear-gradient(90deg,#3aa392 60%,#1a997d);transform:translateY(-2px) scale(1.03)}button[type=button][_ngcontent-%COMP%]{margin-top:.5rem;padding:.8rem;background:#a50505;color:#fff;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer;box-shadow:0 2px 8px #5e6fff14;transition:background .2s,transform .1s}.chat-toggle-btn[_ngcontent-%COMP%]{background:#3b82f6!important;font-size:1rem!important;padding:.8rem 1.2rem!important;font-weight:700!important;border:2px solid #2563eb!important;box-shadow:0 4px 8px #3b82f64d!important}.chat-toggle-btn[_ngcontent-%COMP%]:hover{background:#2563eb!important;transform:translateY(-2px) scale(1.05)!important;box-shadow:0 6px 12px #3b82f666!important}.chat-panel[_ngcontent-%COMP%]{position:fixed;right:-400px;top:80px;width:350px;height:calc(100vh - 100px);background:#fff;border:1px solid #e2e8f0;border-radius:1rem 0 0 1rem;box-shadow:-4px 0 12px #00000026;display:flex;flex-direction:column;transition:right .3s ease-in-out;z-index:1000}.chat-panel.visible[_ngcontent-%COMP%]{right:0}.chat-header[_ngcontent-%COMP%]{background:#1e293b;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;border-radius:1rem 0 0}.chat-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:1.1rem}.connection-status[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem}.reconnect-btn[_ngcontent-%COMP%]{background:none!important;border:none!important;color:#fff!important;font-size:.9rem!important;cursor:pointer;padding:.2rem!important;margin:0!important;border-radius:4px;opacity:.7;transition:opacity .2s}.reconnect-btn[_ngcontent-%COMP%]:hover{background:#ffffff1a!important;opacity:1;transform:none!important}.close-btn[_ngcontent-%COMP%]{background:none!important;border:none!important;color:#fff!important;font-size:1.2rem!important;cursor:pointer;padding:.2rem!important;margin:0!important;border-radius:4px}.close-btn[_ngcontent-%COMP%]:hover{background:#ffffff1a!important;transform:none!important}.chat-messages[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:.8rem;scroll-behavior:smooth}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar{width:8px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#f1f5f9;border-radius:4px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}.chat-messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#94a3b8}.message[_ngcontent-%COMP%]{background:#f8fafc;border:1px solid #e2e8f0;border-radius:.8rem;padding:.8rem;max-width:85%;align-self:flex-start}.message.own-message[_ngcontent-%COMP%]{background:#dbeafe;border-color:#3b82f6;align-self:flex-end}.message-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:.4rem;font-size:.8rem}.user[_ngcontent-%COMP%]{font-weight:600;color:#1e293b}.time[_ngcontent-%COMP%]{color:#64748b}.message-content[_ngcontent-%COMP%]{font-size:.9rem;line-height:1.4;color:#374151;word-wrap:break-word}.no-messages[_ngcontent-%COMP%]{text-align:center;color:#64748b;font-style:italic;margin-top:2rem}.chat-input[_ngcontent-%COMP%]{padding:1rem;border-top:1px solid #e2e8f0;display:flex;gap:.5rem;align-items:center;background:#f8fafc;min-height:60px}.message-input[_ngcontent-%COMP%]{flex:1;padding:.8rem;border:1px solid #e2e8f0;border-radius:8px;font-size:.9rem;outline:none;transition:border-color .2s}.message-input[_ngcontent-%COMP%]:focus{border-color:#3b82f6;box-shadow:0 0 0 3px #3b82f61a}.send-btn[_ngcontent-%COMP%]{background:#dc2626!important;padding:.8rem 1.5rem!important;font-size:1rem!important;font-weight:700!important;border:2px solid #b91c1c!important;border-radius:8px!important;margin:0!important;transition:all .2s!important;color:#fff!important;cursor:pointer!important;min-width:80px!important}.send-btn[_ngcontent-%COMP%]:hover:not(:disabled){background:#b91c1c!important;transform:translateY(-1px) scale(1.05)!important;box-shadow:0 4px 8px #dc26264d!important}.send-btn[_ngcontent-%COMP%]:disabled{background:#9ca3af!important;cursor:not-allowed!important;transform:none!important}.chat-closed-indicator[_ngcontent-%COMP%]{position:fixed;bottom:20px;right:20px;z-index:1000}.chat-indicator-btn[_ngcontent-%COMP%]{background:#3b82f6!important;color:#fff!important;border:none!important;padding:1rem 1.5rem!important;border-radius:50px!important;font-size:1rem!important;font-weight:700!important;box-shadow:0 4px 12px #3b82f64d!important;cursor:pointer!important;margin:0!important;transition:all .3s!important}.chat-indicator-btn[_ngcontent-%COMP%]:hover{background:#2563eb!important;transform:scale(1.1)!important;box-shadow:0 6px 20px #3b82f666!important}.login-warning[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e;text-align:center;padding:.8rem;font-size:.9rem;border-top:1px solid #f3ca20}.message-input[_ngcontent-%COMP%]:disabled{background:#f3f4f6!important;cursor:not-allowed!important;opacity:.6}.test-btn[_ngcontent-%COMP%]{background:#f59e0b!important;padding:.8rem 1rem!important;font-size:.8rem!important;border-radius:8px!important;margin:0!important;transition:all .2s!important}.test-btn[_ngcontent-%COMP%]:hover{background:#d97706!important;transform:translateY(-1px)!important}@media (max-width: 768px){.chat-panel[_ngcontent-%COMP%]{width:100vw;right:-100vw;top:70px;border-radius:0}.chat-header[_ngcontent-%COMP%]{border-radius:0}}"]})};export{W as Home};
